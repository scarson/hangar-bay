---
Phase: 04 - Frontend F001-F002 Contract Listing & Basic Filtering
TaskID: 04.4
ExecutionSequence: 4
PreviousTask: ./04.3-basic-filtering-ui.md
NextTask: ./04.5-final-review-and-cleanup.md
ParentPlan: ../00-mvp-implementation-plan-overview.md
LastUpdated: 2025-06-25
---

# Task 04.4: Implement Advanced Filtering and Sorting

## 1. Objective

To enhance the contract browsing experience by adding sorting capabilities (e.g., by price, date issued). This involves updating the data model, extending the state management service to handle sort parameters, and adding UI controls to the table headers to trigger sorting, making the data table much more interactive and user-friendly.

## 2. Relevant Specifications

*   `design/features/f002-contract-filtering.md`
*   `design/architecture/angular-frontend-architecture.md`
*   `design/angular/guides/04-state-management-and-rxjs.md`
*   `design/angular/guides/07-http-and-data-loading.md`
*   `design/angular/guides/09-testing-strategies.md`
*   `app/frontend/angular/src/app/features/contracts/contract-search.ts` (for existing pattern)
*   `design/angular/guides/09-testing-strategies.md`

## 3. Key Implementation Steps

### 3.0. Pre-flight Checks

*   [ ] **Step 0.1:** Verify the exact sort keys and their behavior by checking the backend implementation in `app/backend/src/fastapi_app/api/contracts.py` and the requirements in `design/features/f002-contract-filtering.md`. Ensure the frontend implementation aligns with the backend's capabilities.

### 3.1. Data Model (`contract.models.ts`)

*   [ ] **Step 1.1:** Extend the `ContractSearchFilters` interface to include optional `sort?: string` and `order?: 'asc' | 'desc'` properties.
    *   **AI Prompt:** "In `contract.models.ts`, add two new optional properties to the `ContractSearchFilters` interface: `sort?: string;` and `order?: 'asc' | 'desc';`."

### 3.2. State Management Service (`contract-search.ts`)

*   [ ] **Step 2.1:** Update the RxJS pipeline to include `sort` and `order` in the `HttpParams` if they exist.
    *   **AI Prompt:** "In `contract-search.ts`, modify the `switchMap` operator. If `filters.sort` and `filters.order` exist, add them as query parameters to the `HttpParams`."

### 3.3. Component UI (`contract-browse-page.html`)

*   [ ] **Step 3.1:** Make the table headers (`<th>`) for sortable columns clickable.
*   [ ] **Step 3.2:** Add a `(click)` event binding to these headers to call a new sorting method.
*   [ ] **Step 3.3:** Add visual indicators (e.g., an icon or class) to the active sort column to show the sort direction (ascending/descending).

### 3.4. Component Logic (`contract-browse-page.ts`)

*   [ ] **Step 4.1:** Create a new method `onSort(sortKey: string)`. This method must validate the `sortKey` against a predefined allowlist of sortable column keys.
*   [ ] **Step 4.2:** Implement the sorting logic. If a new key is clicked, default the direction to `asc`. If the same key is clicked, toggle the direction (`asc` -> `desc` -> `asc`).
*   [ ] **Step 4.3:** Call `this.contractSearch.updateFilters()` with the new `sort` and `order` parameters, and critically, reset the page to `1`.

### 3.5. Route Resolver (`contract-filter-resolver.ts`)

*   [ ] **Step 5.1:** Update the `contractFilterResolver` to read the optional `sort` and `order` query parameters. It must gracefully handle invalid or incomplete inputs (e.g., an invalid `order` value, or `order` without `sort`) by ignoring them and falling back to defaults.
*   [ ] **Step 5.2:** Add the parsed `sort` and `order` values to the `filters` object passed to `contractSearch.setInitialFilters()` to support deep linking.

### 3.6. Testing

*   [ ] **`contract-search.spec.ts`:**
    *   [ ] Verify that calling `updateFilters` with `sort` and `order` adds the correct query parameters to the `HttpParams` in the API call.
    *   [ ] Verify that `sort` and `order` parameters are *not* added to the request if they are undefined in the filters.
*   [ ] **`contract-filter-resolver.spec.ts`:**
    *   [ ] Verify the resolver correctly parses `sort` and `order` from the URL query parameters and includes them in the call to `setInitialFilters`.
    *   [ ] Verify the resolver provides correct default values if `sort` and `order` are not present in the URL.
*   [ ] **`contract-browse-page.spec.ts`:**
    *   [ ] Verify that clicking a sortable table header button calls the `onSort` method with the correct column key.
    *   [ ] Verify the `onSort` toggle logic: first click calls `updateFilters` with `{ order: 'asc' }`, second click with `{ order: 'desc' }`, third click back to `{ order: 'asc' }`.
    *   [ ] Verify that the `aria-sort` attribute on the `<th>` is correctly updated to `ascending` or `descending`.
    *   [ ] Verify that a visual indicator class (e.g., `sort-active`) is applied to the currently sorted column header.

## 4. AI Implementation Guidance

*   Follow the existing signal-based state management pattern.
*   Ensure the sorting UI provides clear visual feedback (e.g., an arrow icon next to the column header) to the user about the current sort state. The icon should be decorative (`aria-hidden="true"`).
*   When a new sort is applied, **always** reset the page to 1.
*   The `onSort` method in the component must validate incoming sort keys against a hardcoded allowlist to prevent unexpected behavior.

## 5. Definition of Done (DoD)

*   [ ] **Implementation Complete:** All placeholder and scaffold code has been replaced with the final, working logic.
*   [ ] The `ContractSearchFilters` interface now includes `sort` and `order` properties.
*   [ ] The `ContractSearch` service correctly adds the sort parameters to the API request.
*   [ ] The `ContractBrowsePage` table headers contain accessible `<button>` elements that trigger sorting.
*   [ ] The UI visually indicates the currently sorted column and direction (e.g., via an icon and/or class).
*   [ ] The `contractFilterResolver` is updated to handle `sort` and `order` query parameters for deep linking.
*   [ ] All new and modified logic is covered by comprehensive unit and integration tests, as detailed in the testing plan, and all tests pass.
*   [ ] All related items in the 'Cross-Cutting Concerns Review' section are addressed and checked off.
*   [ ] Manual accessibility check has been performed (keyboard navigation, screen reader verification) to ensure the sorting feature is fully usable.
*   [ ] All new code is committed to the feature branch.

## 6. Challenges & Resolutions

*   (Placeholder for any challenges encountered and their resolutions during this task.)

## 7. Cross-Cutting Concerns Review

This section documents how the five key cross-cutting concerns were addressed during the completion of this task. Refer to the primary specification documents for detailed guidance:
*   Security: `/design/specifications/security-spec.md`
*   Observability: `/design/specifications/observability-spec.md`
*   Testing: `/design/specifications/test-spec.md`
*   Accessibility: `/design/specifications/accessibility-spec.md`
*   Internationalization (i18n): `/design/specifications/i18n-spec.md`

### 7.1. Security
*   [ ] **Secure Design:** (e.g., threat modeling, principle of least privilege)
*   [ ] **Input Validation:** All sort keys will be from a predefined allowlist within the component, not from user-generated input. This prevents injection of arbitrary values.
*   [ ] **Output Encoding:** N/A. No user-generated content is being displayed.
*   [ ] **Authentication/Authorization:** N/A. Existing page-level authorization is sufficient.
*   [ ] **Secrets Management:** N/A. No secrets involved.
*   [ ] **Dependency Management:** N/A. No new dependencies added.
*   **Notes:** This is a UI-focused task where sorting parameters are based on a fixed, internal set of column keys. The primary security consideration, input validation, is handled by design.

### 7.2. Observability
*   [ ] **Structured Logging:** N/A.
*   [ ] **Key Events Logged:** N/A. UI interactions are not logged at this level.
*   [ ] **Error Logging:** The existing `ContractSearch` service's error handling will cover any API errors that might occur during a sorted data fetch. No new error logging paths are needed.
*   [ ] **Correlation IDs:** N/A. Handled by existing infrastructure.
*   [ ] **Metrics:** N/A.
*   **Notes:** No new logic requires specific observability hooks. Existing service-level error handling is sufficient.

### 7.3. Testing
*   [ ] **Unit Tests:** Unit tests must be added for the new logic in the service (`contract-search.spec.ts`), resolver (`contract-filter-resolver.spec.ts`), and component (`contract-browse-page.spec.ts`).
*   [ ] **Integration Tests:** Component tests will verify the integration between the clickable headers and the `ContractSearch` service call.
*   [ ] **Test Coverage:** Aim to maintain or increase existing coverage levels for modified files.
*   [ ] **Test Data Management:** Existing mock data will be used.
*   **Notes:** Testing is a critical part of this task. Specific test cases are outlined in section 3.5.

### 7.4. Accessibility (A11y)
*(Primarily for UI-related tasks, but consider CLI/API accessibility where relevant)*
*   [ ] **Semantic HTML/Structure:** Clickable headers should be implemented as `<button>` elements inside the `<th>` for proper semantics and keyboard accessibility.
*   [ ] **ARIA Attributes:** Use `aria-sort` (`ascending`, `descending`, or `other` for the active column, and `none` for inactive columns) on the `<th>` elements to indicate the sort state to screen readers.
*   [ ] **Keyboard Navigability:** Using `<button>` elements ensures headers are focusable and activatable with Enter/Space keys.
*   [ ] **Color Contrast:** N/A. No new colors introduced.
*   [ ] **Screen Reader Compatibility:** The `aria-sort` attribute is the primary mechanism for screen reader compatibility.
*   [ ] **Alternative Text for Images:** Sort indicator icons should be decorative (`aria-hidden="true"`) as the `aria-sort` attribute provides the semantic meaning.
*   **Notes:** Ensure the sorting controls are fully accessible by following the guidance on using buttons and `aria-sort`.

### 7.5. Internationalization (I18n)
*(Primarily for UI-related tasks, but consider for any user-facing text including logs/error messages)*
*   [ ] **Text Abstraction:** Any new tooltips or accessible labels for sorting indicators must be marked with `i18n` attributes.
*   [ ] **Locale-Specific Formatting:** N/A.
*   [ ] **UI Layout Adaptability:** N/A.
*   [ ] **Character Encoding:** N/A.
*   **Notes:** No new user-facing text is anticipated, but if any is added (e.g., a tooltip on the sort button), it must be internationalized.
