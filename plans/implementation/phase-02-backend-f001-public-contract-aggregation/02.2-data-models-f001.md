# Task 02.2: Data Models for F001

**Phase:** 02 - Backend - F001: Public Contract Aggregation
**Parent Plan:** [MVP Implementation Plan Overview](../00-mvp-implementation-plan-overview.md)
**Last Updated:** 2025-06-06

## 1. Objective

To define SQLAlchemy data models for storing processed EVE Online contract data relevant to F001, including contracts, contract items, and any necessary supporting information (e.g., regions, stations, item types if not relying solely on SDE).

## 2. Relevant Specifications

*   `../../../design/design-spec.md` (Sections: Data Tier, Data Models)
*   `../../../design/features/F001-Public-Contract-Aggregation-Display.md` (Data fields required for display and filtering)
*   Task 01.2: Database Setup (SQLAlchemy `Base`)
*   EVE Online SDE (Static Data Export) for reference on data types and relationships.

## 3. Key Implementation Steps

*   [ ] **Identify Core Entities:**
    *   Based on F001, identify key entities to model:
        *   `Contract` (public contracts)
        *   `ContractItem` (items within contracts)
        *   Potentially simplified `Region`, `Station`, `ItemType` if local caching/subset is desired beyond direct ESI lookups.
*   [ ] **Define `Contract` Model:**
    *   Create `app/models/contract.py` (or similar).
    *   Define `Contract` SQLAlchemy model inheriting from `Base`.
    *   Include fields like: `contract_id` (primary key), `issuer_id`, `issuer_corporation_id`, `assignee_id`, `start_location_id`, `end_location_id`, `type` (auction, item_exchange), `status`, `title`, `for_corporation`, `date_issued`, `date_expired`, `date_completed`, `price`, `reward`, `collateral`, `volume`, `region_id`.
    *   Define relationships (e.g., one-to-many with `ContractItem`).
    *   Add appropriate indexes for query performance (e.g., on `region_id`, `type`, `status`, `date_issued`).
    *   **AI Prompt:** "Generate a SQLAlchemy model class `Contract` with fields: `contract_id` (PK, BigInteger), `issuer_id` (Integer), `type` (String), `status` (String), `date_issued` (DateTime), `price` (Numeric), `region_id` (Integer, FK to a potential Region table). Include a one-to-many relationship to `ContractItem` and an index on `region_id` and `date_issued`."
*   [ ] **Define `ContractItem` Model:**
    *   In the same file or `app/models/contract_item.py`.
    *   Define `ContractItem` SQLAlchemy model.
    *   Include fields like: `record_id` (primary key from ESI), `contract_id` (foreign key to `Contract`), `type_id` (item type), `quantity`, `is_included`, `is_singleton`.
    *   **AI Prompt:** "Generate a SQLAlchemy model class `ContractItem` with fields: `record_id` (PK, BigInteger), `contract_id` (FK to `Contract.contract_id`), `type_id` (Integer), `quantity` (Integer), `is_included` (Boolean)."
*   [ ] **(Optional) Supporting Models:**
    *   Consider if simplified local tables for `Region`, `Station`, `ItemType` are needed for MVP to reduce ESI calls or if direct lookups/SDE integration is preferred. For MVP, direct lookups or minimal caching might suffice.
*   [ ] **Alembic Migration:**
    *   Generate a new Alembic migration for these models: `alembic revision -m "Add contract and contract_item models" --autogenerate`.
    *   Review the generated migration script for correctness.
    *   Apply the migration: `alembic upgrade head`.

## 4. AI Implementation Guidance

*   Ensure data types in models match ESI data types appropriately (e.g., integers, strings, datetimes, numeric for prices).
*   Use SQLAlchemy's relationship features to define connections between models.
*   Define indexes on columns frequently used in query filters or sorting.
*   `--autogenerate` for Alembic is helpful but always review the output.

## 5. Definition of Done

*   SQLAlchemy models for `Contract` and `ContractItem` are defined.
*   Relationships and necessary indexes are included in the models.
*   An Alembic migration script is generated and successfully applied to the database schema.
*   All new files and code changes are committed to version control.
