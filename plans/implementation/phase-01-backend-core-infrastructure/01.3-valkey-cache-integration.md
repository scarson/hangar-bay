# Task 01.3: Valkey Caching Layer Integration

**Phase:** 01 - Backend Core Infrastructure
**Parent Plan:** [MVP Implementation Plan Overview](../00-mvp-implementation-plan-overview.md)
**Last Updated:** 2025-06-08

## 1. Objective

To integrate Valkey (or a compatible Redis client) as a caching layer for the backend application, configure its connection, and provide a basic utility or dependency for accessing the cache.

## 2. Relevant Specifications

*   `../../../design/design-spec.md` (Sections: Caching Strategy, Technology Stack)
*   `../../../design/performance-spec.md` (General caching benefits)
*   Task 00.2: Configuration Management (for `CACHE_URL`)

## 3. Key Implementation Steps

*   [ ] **Redis Client Installation (Async):**
    *   Use PDM to add the `redis` library with `aioredis` extras for asynchronous support: `pdm add "redis[aioredis]"`.
    *   Verify that `redis` is listed as a dependency in `app/backend/pyproject.toml` and that `app/backend/pdm.lock` is updated.
*   [ ] **Cache Connection Setup:**
    *   Create `app/backend/src/fastapi_app/core/cache.py`.
    *   Initialize an asynchronous Redis client instance (e.g., `redis.asyncio.from_url`) using the `CACHE_URL` from Pydantic settings (defined in `app/backend/src/fastapi_app/config.py`).
    *   Implement an async function to test the connection (e.g., by PINGing the server).
    *   Integrate cache client initialization (e.g., creating a connection pool) and closing into the FastAPI application lifecycle events (startup/shutdown) in `app/backend/src/fastapi_app/main.py`. The client instance could be stored on `app.state` for access.
    *   **AI Prompt for `cache.py`:** "Generate Python code for `app/backend/src/fastapi_app/core/cache.py` to define a class or functions for managing an asynchronous Redis client. It should include a way to get the client instance (which will be initialized at app startup)."
    *   **AI Prompt for `main.py` lifecycle:** "Show how to modify `app/backend/src/fastapi_app/main.py` to initialize the async Redis client (defined in `fastapi_app.core.cache`) on application startup, store it (e.g., on `app.state.redis`), and properly close its connection pool on application shutdown. Ensure the `CACHE_URL` is retrieved from the app's Pydantic settings."
*   [ ] **Cache Dependency/Utility:**
    *   Provide an async FastAPI dependency (e.g., `async def get_cache(request: Request) -> redis.asyncio.Redis: return request.app.state.redis`) to get the Redis client instance for use in services or API endpoints.
    *   **AI Prompt for dependency:** "Generate an async FastAPI dependency function `get_cache(request: Request)` that retrieves the initialized asynchronous Redis client instance (e.g., from `request.app.state.redis`)."
*   [ ] **Basic Cache Usage (Example/Test):**
    *   (Optional, for testing) Implement a temporary test endpoint or a unit test that sets and gets a value from the cache to verify connectivity.

## 4. AI Implementation Guidance

*   Ensure the cache connection URL (`CACHE_URL`) is added to and managed via Pydantic settings in `app/backend/src/fastapi_app/config.py`.
*   The `redis.asyncio` client handles connection pooling by default when created with `from_url`.
*   Consider graceful handling if the cache server is unavailable (e.g., log error, return None or fallback data). For MVP, failing on connection issues during startup or critical operations might be acceptable initially, but should be logged clearly.

## 5. Definition of Done

*   Asynchronous Redis client (`redis.asyncio`) is configured and connects to the Valkey/Redis server using settings from Pydantic.
*   An async FastAPI dependency is available to access the Redis client instance.
*   Basic cache operation (e.g., PING, or set/get for testing) is confirmed to be working.
*   All new files and code changes are committed to version control.

## 6. Challenges & Resolutions

*   (Placeholder for any challenges encountered and their resolutions during this task.)

## 7. Cross-Cutting Concerns Review

This section documents how the five key cross-cutting concerns were addressed during the completion of this task. Refer to the primary specification documents for detailed guidance:
*   Security: `../../../design/security-spec.md`
*   Observability: `../../../design/observability-spec.md`
*   Testing: `../../../design/test-spec.md`
*   Accessibility: `../../../design/accessibility-spec.md`
*   Internationalization (i18n): `../../../design/i18n-spec.md`

### 7.1. Security
*   [ ] **Secure Design:** (e.g., threat modeling, principle of least privilege)
*   [ ] **Input Validation:** (e.g., validating all external inputs)
*   [ ] **Output Encoding:** (e.g., preventing XSS)
*   [ ] **Authentication/Authorization:** (e.g., ensuring proper checks)
*   [ ] **Secrets Management:** (e.g., secure storage and access)
*   [ ] **Dependency Management:** (e.g., checking for vulnerable libraries)
*   **Notes:** (Detail specific actions taken or rationale for no action, especially if a category is not applicable to this task.)

### 7.2. Observability
*   [ ] **Structured Logging:** (e.g., using key-value pairs, JSON format)
*   [ ] **Key Events Logged:** (e.g., task initiation, completion, critical errors, significant state changes)
*   [ ] **Error Logging:** (e.g., comprehensive error details, stack traces)
*   [ ] **Correlation IDs:** (e.g., for tracing requests across services)
*   [ ] **Metrics:** (e.g., performance indicators, resource usage - if applicable)
*   **Notes:** (Detail specific actions taken or rationale for no action.)

### 7.3. Testing
*   [ ] **Unit Tests:** (e.g., for new functions, classes, components)
*   [ ] **Integration Tests:** (e.g., for interactions between components/services)
*   [ ] **Test Coverage:** (e.g., summary of coverage achieved or targeted)
*   [ ] **Test Data Management:** (e.g., how test data is sourced/managed)
*   **Notes:** (Detail specific actions taken or rationale for no action.)

### 7.4. Accessibility (A11y)
*(Primarily for UI-related tasks, but consider CLI/API accessibility where relevant)*
*   [ ] **Semantic HTML/Structure:** (e.g., using appropriate tags for meaning)
*   [ ] **ARIA Attributes:** (e.g., for dynamic content or custom controls)
*   [ ] **Keyboard Navigability:** (e.g., all interactive elements reachable and operable via keyboard)
*   [ ] **Color Contrast:** (e.g., ensuring sufficient contrast for text and UI elements)
*   [ ] **Screen Reader Compatibility:** (e.g., testing with screen readers)
*   [ ] **Alternative Text for Images:** (e.g., providing descriptive alt text)
*   **Notes:** (Detail specific actions taken or rationale for no action, especially if not UI-related.)

### 7.5. Internationalization (I18n)
*(Primarily for UI-related tasks, but consider for any user-facing text including logs/error messages)*
*   [ ] **Text Abstraction:** (e.g., using translation keys instead of hardcoded strings)
*   [ ] **Locale-Specific Formatting:** (e.g., for dates, numbers, currencies)
*   [ ] **UI Layout Adaptability:** (e.g., for text expansion in different languages)
*   [ ] **Character Encoding:** (e.g., using UTF-8)
*   **Notes:** (Detail specific actions taken or rationale for no action, especially if not UI-related.)

---
<!-- This section should be placed before any final "Task Completion Checklist" or similar concluding remarks. -->
