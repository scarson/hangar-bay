# Task 05.1: Advanced Search, Filtering, and Sorting API

**Phase:** 05 - Backend - F002: Advanced Search & Filtering Logic
**Parent Plan:** [MVP Implementation Plan Overview](../00-mvp-implementation-plan-overview.md)
**Last Updated:** 2025-06-28

## 1. Objective

To enhance the backend API and database query capabilities to support the advanced search, multi-field filtering, and dynamic sorting requirements defined in Feature F002. This involves creating a flexible query service and updating the primary contracts API endpoint to accept a wide range of parameters, providing a powerful and performant search experience for the frontend.

## 2. Relevant Specifications & Patterns

*   **Feature Spec:** `/design/features/F002-Ship-Browsing-Advanced-Search-Filtering.md`
*   **Architecture:** `/design/fastapi/00-fastapi-architecture-overview.md`
*   **Pattern:** `/design/fastapi/patterns/02-service-construction.md`
*   **Pattern:** `/design/fastapi/patterns/06-schema-model-parity.md`
*   **Guide:** `/design/fastapi/guides/09-testing-strategies.md`

## 3. Key Implementation Steps

*   [x] **Step 1: Define Comprehensive Pydantic Filter and Response Models**
    *   In `fastapi_app/schemas/contract.py`, define a [SortDirection](/app/backend/src/fastapi_app/schemas/contracts.py:69:0-71:17) Enum: `asc` and `desc`.
    *   Define a `SortableContractFields` Enum for all allowed sort keys (e.g., `price`, `date_issued`, `collateral`, `ship_name`). This enforces type safety and prevents SQL injection.
    *   Define the primary [ContractFilters](/app/backend/src/fastapi_app/schemas/contracts.py:74:0-141:5) Pydantic model to encapsulate all filter, pagination, and sorting parameters. This model will be injected into the API endpoint using `Depends`.
        *   Use FastAPI's `Query` for detailed validation (e.g., `Optional`, `gt`, `min_length`, list types) and to provide descriptions that will appear in the OpenAPI docs.
        *   The sort fields should use the new enums: `sort_by: Optional[SortableContractFields] = SortableContractFields.date_issued`, `sort_direction: Optional[SortDirection] = SortDirection.desc`.
    *   In `fastapi_app/schemas/common.py`, ensure a generic `PaginatedResponse` schema exists or create one. It should be a Pydantic `GenericModel` to handle any type of item list.
        ```python
        # schemas/common.py
        from pydantic.generics import GenericModel
        from pydantic import Field
        from typing import Generic, TypeVar, List

        T = TypeVar('T')

        class PaginatedResponse(GenericModel, Generic[T]):
            total: int = Field(..., description="Total number of items")
            page: int = Field(..., description="Current page number")
            size: int = Field(..., description="Number of items per page")
            items: List[T] = Field(..., description="List of items for the current page")
        ```

*   [x] **Step 2: Create Contract Service for Query Logic**
    *   In accordance with the **[Service Construction Pattern](/design/fastapi/patterns/02-service-construction.md)**, create a new module: `app/backend/src/fastapi_app/services/contract_service.py`.
    *   Implement a central function, `async def get_contracts(db: AsyncSession, filters: ContractFilters) -> PaginatedResponse[ContractSchema]`.
    *   This function will contain all database query logic, including filtering, sorting, and pagination. This separates complex query construction from the API endpoint, improving testability and maintainability.

*   [x] **Step 3: Implement Dynamic Filtering in Contract Service**
    *   Inside `app/backend/src/fastapi_app/services/contract_service.py`, build the base SQLAlchemy query: `query = select(Contract).join(EsiTypeCache, Contract.type_id == EsiTypeCache.type_id)`.
    *   Dynamically apply filter conditions (`.where()`) to the query *only if* they are present in the `filters` object.
    *   Use `ilike` for case-insensitive text searches.
    *   Handle numeric range filters (e.g., `price >= min_price`).
    *   Handle `IN` clauses for list-based filters (e.g., `Contract.start_location_id.in_(...)`).

*   [x] **Step 4: Implement Dynamic Sorting and Pagination in Contract Service**
    *   Create a `SORT_MAP` dictionary to safely map the `SortableContractFields` enum values to the actual SQLAlchemy model columns. This is a critical security step.
        ```python
        SORT_MAP = {
            SortableContractFields.price: Contract.price,
            SortableContractFields.date_issued: Contract.date_issued,
            SortableContractFields.ship_name: EsiTypeCache.name,
            # ... other fields
        }
        ```
    *   Apply the `order_by` clause to the query using the mapping and the `sort_direction` (`.asc()` or `.desc()`).
    *   Apply pagination logic using `.offset()` and `.limit()` based on `filters.page` and `filters.size`.
    *   Execute two queries: one to get the `total` count of items matching the filters (before pagination), and a second to get the paginated list of items.
    *   Return a `PaginatedResponse` object populated with the results.

*   [x] **Step 5: Update API Endpoint to Use Contract Service**
    *   Refactor the `/api/v1/contracts/ships` endpoint in `app/backend/src/fastapi_app/api/v1/endpoints/contracts.py`.
    *   The endpoint's implementation should now be a simple one-liner: it takes the [ContractFilters](/app/backend/src/fastapi_app/schemas/contracts.py:74:0-141:5) dependency, calls the `services.contract_service.get_contracts` function, and returns its result. The endpoint should have a `response_model` of `PaginatedResponse[ContractSchema]`.

*   [x] **Step 6: Performance Review and Indexing**
    *   Based on the full set of filterable and sortable fields, review the [Contract](/app/backend/src/fastapi_app/models/contracts.py:36:0-77:82) and `EsiTypeCache` models.
    *   Add or update database indexes as needed via a new Alembic migration file. Pay special attention to columns used in `WHERE` clauses, `JOIN`s, and `ORDER BY` clauses.
    *   **AI Prompt:** "Given the filterable fields in the [ContractFilters](/app/backend/src/fastapi_app/schemas/contracts.py:74:0-141:5) model (text search on `Contract.title` and `EsiTypeCache.name`; ranges on `price`, `collateral`; IN clauses on [region_id](/app/backend/src/fastapi_app/core/config.py:36:4-84:9), `type_id`), and sortable fields (`price`, `date_issued`, `name`), what database indexes should be added to the [Contract](/app/backend/src/fastapi_app/models/contracts.py:36:0-77:82) and `EsiTypeCache` tables to optimize query performance? Provide the SQLAlchemy `Index` definitions."

*   [ ] **Step 7: Update Integration Tests**
    *   Update the `TestClient` integration tests for the `/api/v1/contracts/ships` endpoint.
    *   Add new test cases that verify the functionality of various advanced filter combinations and sorting options.

## 4. AI Implementation Guidance

*   **Separation of Concerns:** Keep the API endpoint file (`endpoints/contracts.py`) clean and focused on routing and request/response handling. All the complex business logic for building database queries should reside in the [services/contract_service.py](/app/backend/src/fastapi_app/services/contract_service.py:0:0-0:0) service, as per the architecture overview.
*   **Safe Sorting:** The `SORT_MAP` is a non-negotiable security measure. Always validate the `sort_by` parameter against this pre-defined mapping of enums to columns.
*   **Schema-Model Parity:** When creating the [ContractSchema](/app/backend/src/fastapi_app/schemas/contracts.py:24:0-48:51) and `PaginatedResponse`, ensure they align with the [Contract](/app/backend/src/fastapi_app/models/contracts.py:36:0-77:82) ORM model as defined in the **[Schema-Model Parity Pattern](/design/fastapi/patterns/06-schema-model-parity.md)**.

## 5. Definition of Done

*   A new [services/contract_service.py](/app/backend/src/fastapi_app/services/contract_service.py:0:0-0:0) module exists and contains the advanced query logic.
*   The [ContractFilters](/app/backend/src/fastapi_app/schemas/contracts.py:74:0-141:5) and `PaginatedResponse` Pydantic models are defined and used by the API.
*   The `/api/v1/contracts/ships` endpoint is updated to accept all advanced filter, sort, and pagination parameters, and it uses the new contract service.
*   Necessary database indexes have been added via an Alembic migration.
*   Integration tests are updated to cover new filtering and sorting functionality.
*   All changes are committed to version control.

## 6. Challenges & Resolutions

*   (Placeholder for any challenges encountered and their resolutions during this task.)

## 7. Cross-Cutting Concerns Review

This section documents how the five key cross-cutting concerns were addressed during the completion of this task. Refer to the primary specification documents for detailed guidance:
*   Security: `/design/specifications/security-spec.md`
*   Observability: `/design/specifications/observability-spec.md`
*   Testing: `/design/specifications/test-spec.md`
*   Accessibility: `/design/specifications/accessibility-spec.md`
*   Internationalization (i18n): `/design/specifications/i18n-spec.md`

### 7.1. Security
*   [ ] **Secure Design:** The primary security design consideration is preventing SQL injection through the dynamic sorting parameter. This will be mitigated by mapping API-facing sort keys to specific, safe SQLAlchemy column objects.
*   [ ] **Input Validation:** All incoming filter, sort, and pagination parameters will be strictly validated by the `ContractFilters` Pydantic model, using FastAPI's `Query` for constraints on types, ranges, and lengths.
*   [x] **Output Encoding:** N/A. This API endpoint returns JSON data, not HTML. The responsibility for preventing XSS by properly encoding output lies with the frontend client that consumes this data.
*   [ ] **Authentication/Authorization:** This is a public, unauthenticated endpoint. No specific authentication or authorization checks are required for this task.
*   [x] **Secrets Management:** N/A. This task does not involve handling any secrets, API keys, or credentials.
*   [ ] **Dependency Management:** All dependencies are managed via `pdm` and pinned in `pyproject.toml`. No new dependencies are anticipated for this task, but if any were added, they would be subject to review.
*   **Notes:** The core security focus is robust input validation via Pydantic and safe handling of the dynamic `sort_by` parameter to prevent misuse.

### 7.2. Observability
*   [ ] **Structured Logging:** Logging will be implemented to capture the key filter parameters used in each API call. This will help diagnose performance issues or unexpected results from complex queries.
*   [ ] **Key Events Logged:** The primary event to log is the execution of a search query, including the filter criteria.
*   [ ] **Error Logging:** Any database errors or validation errors that occur during query construction or execution will be logged with sufficient detail for debugging.
*   [x] **Correlation IDs:** N/A. While important for a distributed system, this is a single monolithic backend service, so request tracing across services is not applicable for this task.
*   [ ] **Metrics:** We will consider adding a metric for query execution time to monitor the performance of the dynamic query generation.
*   **Notes:** The main goal for observability in this task is to gain insight into how the advanced filtering is being used and how it performs.

### 7.3. Testing
*   [ ] **Unit Tests:** Unit tests will be created for the `crud.contract` service layer to test the query-building logic in isolation from the database and API.
*   [ ] **Integration Tests:** As per the **[Testing Strategies Guide](/design/fastapi/guides/09-testing-strategies.md)**, expand `TestClient` integration tests for the contracts endpoint to cover:
    *   At least one of each filter type (text, range, list).
    *   Both `asc` and `desc` sort directions.
    *   A case for an invalid `sort_by` parameter to ensure it's handled gracefully.
    *   A test case that spans multiple pages.
*   [ ] **Test Coverage:** We will aim to achieve high test coverage for the new `crud.contract` module.
*   [ ] **Test Data Management:** Tests will rely on a pre-populated test database, with specific records designed to validate different filtering scenarios (e.g., contracts that should match a price range, contracts that shouldn't, etc.).
*   **Notes:** A robust set of integration tests is critical for this task to ensure the complex filtering logic is behaving as expected from the API consumer's perspective.

### 7.4. Accessibility (A11y)
*(Primarily for UI-related tasks, but consider CLI/API accessibility where relevant)*
*   [x] **Semantic HTML/Structure:** N/A. This is a backend API task.
*   [x] **ARIA Attributes:** N/A. This is a backend API task.
*   [x] **Keyboard Navigability:** N/A. This is a backend API task.
*   [x] **Color Contrast:** N/A. This is a backend API task.
*   [x] **Screen Reader Compatibility:** N/A. This is a backend API task.
*   [x] **Alternative Text for Images:** N/A. This is a backend API task.
*   **Notes:** N/A. This is a backend-only task that produces JSON data and has no user interface. Accessibility concerns will be handled by the frontend client.

### 7.5. Internationalization (I18n)
*(Primarily for UI-related tasks, but consider for any user-facing text including logs/error messages)*
*   [x] **Text Abstraction:** N/A. The API returns raw data. Any user-facing strings (like ship names) come directly from the ESI data source and are not localized at the backend level.
*   [x] **Locale-Specific Formatting:** N/A. The API returns data in standard formats (e.g., ISO 8601 for dates, standard float/int for numbers). It is the client's responsibility to format this data for the user's locale.
*   [x] **UI Layout Adaptability:** N/A. This is a backend API task.
*   [ ] **Character Encoding:** The service will operate assuming UTF-8 encoding for all text data, which is standard for FastAPI and modern web applications.
*   **Notes:** N/A. This is a backend-only task. Internationalization is not a concern for the data layer in this context.
